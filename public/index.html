<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Better Music GPT</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <script src="scripts/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-md5@0.8.3/src/md5.min.js"></script>
    <style>
      /* --- ê¸°ë³¸ & í…Œë§ˆ ì„¤ì • --- */
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

      :root {
        --bg-color: #121212;
        --text-color: #e0e0e0;
        --primary-color: #1db954; /* Spotify Green */
        --input-bg-color: #282828;
        --highlight-color: #ffffff;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: 'Noto Sans KR', sans-serif;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        text-align: center;
      }

      /* ğŸ‘‡ ì—¬ê¸°ì— ë¡œê³  ìŠ¤íƒ€ì¼ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. */
      #logo {
        position: fixed; /* í™”ë©´ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ê³ ì • */
        top: 20px;
        left: 20px;
        z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œë“¤ ìœ„ì— í‘œì‹œ */

        font-size: 1.6rem;
        font-weight: 700; /* êµµì€ ê¸€ì”¨ì²´ */
        color: var(--highlight-color); /* ê°€ì¥ ë°ì€ í°ìƒ‰ */
        cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë‹¤ëŠ” í‘œì‹œ */
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); /* í…ìŠ¤íŠ¸ê°€ ë‹ë³´ì´ê²Œ í•˜ëŠ” ê·¸ë¦¼ì íš¨ê³¼ */
      }

      /* --- í˜ë¥´ì†Œë‚˜ ì„ íƒê¸° ìŠ¤íƒ€ì¼ --- */
      #persona-selector-container {
        position: fixed; /* í™”ë©´ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ê³ ì • */
        top: 20px;
        right: 20px;
        z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œë“¤ ìœ„ì— í‘œì‹œ */
        display: flex;
        align-items: center;
        flex-direction: row-reverse;
      }

      #current-persona-wrapper {
        display: flex;
        flex-direction: column; /* ì•„ì´ì½˜ê³¼ ì´ë¦„ì„ ì„¸ë¡œë¡œ ë°°ì¹˜ */
        align-items: center; /* ê°€ìš´ë° ì •ë ¬ */
        cursor: pointer;
        width: 80px; /* ì´ë¦„ì´ ê¸¸ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë„ˆë¹„ í™•ë³´ */
      }

      #current-persona {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid var(--text-color);
        transition: transform 0.2s;
      }

      #current-persona-wrapper:hover #current-persona {
        transform: scale(1.1);
      }

      /* ğŸ‘‡ ìƒˆë¡œ ì¶”ê°€ëœ ì´ë¦„ ìŠ¤íƒ€ì¼ */
      #current-persona-name {
        font-size: 0.8rem;
        font-weight: bold;
        margin-top: 4px;
        white-space: nowrap; /* ì´ë¦„ì´ ê¸¸ì–´ë„ í•œ ì¤„ë¡œ í‘œì‹œ */
      }

      /* í˜ë¥´ì†Œë‚˜ ëª©ë¡ (ì• ë‹ˆë©”ì´ì…˜ ì ìš©) */
      #persona-list {
        display: flex;
        gap: 15px;
        padding: 10px;
        background-color: rgba(40, 40, 40, 0.8);
        backdrop-filter: blur(5px); /* ë°°ê²½ ë¸”ëŸ¬ íš¨ê³¼ */
        border-radius: 20px;
        margin-left: 10px;

        /* ì´ˆê¸° ìƒíƒœ (ìˆ¨ê²¨ì§„ ìƒíƒœ) */
        visibility: hidden;
        opacity: 0;
        transform: translateX(-20px); /* ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì‚´ì§ ì´ë™ëœ ìƒíƒœì—ì„œ ì‹œì‘ */
        transition: all 0.4s ease-in-out;
      }

      /* í™œì„±í™” ìƒíƒœ (í¼ì³ì§„ ìƒíƒœ) */
      #persona-list.active {
        visibility: visible;
        opacity: 1;
        transform: translateX(0);
      }

      .persona-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .persona-item:hover {
        transform: scale(1.1);
      }

      .persona-item img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
      }

      .persona-item span {
        font-size: 0.8rem;
        font-weight: bold;
      }

      .scene {
        width: 100%;
        max-width: 800px;
        /* ëª¨ë“  sceneì„ ê°™ì€ ìœ„ì¹˜ì— ê²¹ì¹˜ê²Œ ì„¤ì • */
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);

        /* ê¸°ë³¸ì ìœ¼ë¡œëŠ” íˆ¬ëª…í•˜ê²Œ ìˆ¨ê²¨ë‘  */
        opacity: 0;

        /* display: none ëŒ€ì‹  opacityì™€ pointer-eventsë¡œ ì œì–´ */
        pointer-events: none;

        /* opacityê°€ ë³€í•  ë•Œ 0.5ì´ˆ ë™ì•ˆ ë¶€ë“œëŸ½ê²Œ ì• ë‹ˆë©”ì´ì…˜ ì ìš© */
        transition: opacity 0.5s ease-in-out;
      }

      /* --- Scene 1: ì…ë ¥ --- */
      #scene1 h1 {
        font-size: 2.5rem;
        margin-bottom: 30px;
      }
      #prompt-input {
        width: 80%;
        padding: 15px;
        font-size: 1.1rem;
        border-radius: 25px;
        border: 1px solid var(--input-bg-color);
        background-color: var(--input-bg-color);
        color: var(--text-color);
        margin-bottom: 20px;
        font-family: inherit;
        resize: none;
        min-height: 50px;
      }
      #generate-btn {
        padding: 15px 30px;
        font-size: 1.2rem;
        font-weight: bold;
        border-radius: 25px;
        border: none;
        background-color: var(--primary-color);
        color: white;
        cursor: pointer;
        transition: transform 0.2s;
      }
      #generate-btn:hover {
        transform: scale(1.05);
      }

      /* --- Scene 2: ë¡œë”© --- */
      #loading-album-cover {
        width: 250px;
        height: 250px;
        border-radius: 15px;
        object-fit: cover;
        margin: 40px auto 20px auto; /* ìœ„, ì¢Œìš°, ì•„ë˜ ë§ˆì§„ */
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5); /* ì…ì²´ê° íš¨ê³¼ */
      }

      .spinner {
        border: 8px solid var(--input-bg-color);
        border-top: 8px solid var(--primary-color);
        border-radius: 50%;
        width: 80px;
        height: 80px;
        animation: spin 1s linear infinite;
        margin: 50px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .inline-spinner {
        display: inline-block; /* í…ìŠ¤íŠ¸ ì˜†ì— ìœ„ì¹˜í•˜ë„ë¡ ì„¤ì • */
        width: 16px;
        height: 16px;
        border: 3px solid var(--input-bg-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        vertical-align: middle; /* í…ìŠ¤íŠ¸ì™€ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        margin-right: 8px; /* í…ìŠ¤íŠ¸ì™€ì˜ ê°„ê²© */
      }

      #loading-text {
        font-size: 1.4rem; /* ê¸´ ë¬¸ë‹¨ì„ ìœ„í•´ í°íŠ¸ í¬ê¸° ì‚´ì§ ì¡°ì • */
        line-height: 1.6; /* ê°€ë…ì„±ì„ ìœ„í•œ ì¤„ ê°„ê²© ì¶”ê°€ */
        text-align: left; /* ê¸´ ê¸€ì€ ì™¼ìª½ ì •ë ¬ì´ ë” ì½ê¸° í¸í•©ë‹ˆë‹¤. */
        padding: 0 20px; /* ì¢Œìš° ì—¬ë°±ìœ¼ë¡œ ë‹µë‹µí•¨ í•´ì†Œ */
        margin-top: 20px; /* ìŠ¤í”¼ë„ˆì™€ì˜ ê°„ê²© í™•ë³´ */
        white-space: pre-wrap; /* \nê³¼ ê°™ì€ ì¤„ë°”ê¿ˆ ë¬¸ìë¥¼ ì¸ì‹í•˜ë„ë¡ ì„¤ì • */
      }

      /* --- Scene 3: ê²°ê³¼ --- */
      #song-title {
        font-size: 2.2rem; /* ì œëª© í°íŠ¸ í¬ê¸°ë¥¼ í‚¤ì›ë‹ˆë‹¤. */
        font-weight: 700; /* êµµê²Œ í‘œì‹œí•©ë‹ˆë‹¤. */
        color: var(--highlight-color); /* ë” ë°ì€ í°ìƒ‰ìœ¼ë¡œ ê°•ì¡°í•©ë‹ˆë‹¤. */
        margin-top: 0;
        margin-bottom: 20px; /* ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ì™€ì˜ ê°„ê²©ì„ ì¤ë‹ˆë‹¤. */
        text-align: left; /* ì™¼ìª½ ì •ë ¬ì„ ìœ ì§€í•©ë‹ˆë‹¤. */
      }
      #new-song-btn {
        position: absolute;
        top: 0;
        right: 0;
        padding: 10px 20px;
        border-radius: 20px;
        border: 1px solid var(--text-color);
        background: none;
        color: var(--text-color);
        cursor: pointer;
      }
      .player-container {
        display: flex;
        gap: 30px;
        align-items: center;
        margin-top: 50px;
      }
      #album-cover {
        width: 250px;
        height: 250px;
        border-radius: 10px;
        object-fit: cover;
      }
      .lyrics-section {
        flex-grow: 1;
        text-align: left;
      }
      #audio-player {
        color-scheme: dark;
        width: 100%;
        margin-bottom: 20px;
      }
      #lyrics-container {
        height: 150px;
        overflow-y: auto;
        font-size: 1.5rem;
        line-height: 1.6;
      }
      #lyrics-container p {
        margin: 0;
        opacity: 0.5;
        transition:
          opacity 0.3s,
          color 0.3s;
      }
      #lyrics-container p.highlight {
        color: var(--primary-color);
        font-weight: bold;
        opacity: 1;
      }

      /* --- ê°€ì‚¬ì°½ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ --- */

      /* Firefox ë¸Œë¼ìš°ì €ìš© */
      #lyrics-container {
        scrollbar-width: thin; /* ìŠ¤í¬ë¡¤ë°”ë¥¼ ì–‡ê²Œ ë§Œë“­ë‹ˆë‹¤. */
        scrollbar-color: var(--primary-color) transparent; /* ìŠ¤í¬ë¡¤ë°” ìƒ‰ìƒ, ë°°ê²½ ìƒ‰ìƒ ìˆœ */
      }

      /* Chrome, Safari, Edge ë“± ì›¹í‚· ë¸Œë¼ìš°ì €ìš© */
      #lyrics-container::-webkit-scrollbar {
        width: 10px; /* ìŠ¤í¬ë¡¤ë°”ì˜ ë„ˆë¹„ */
      }

      #lyrics-container::-webkit-scrollbar-track {
        background: transparent; /* ìŠ¤í¬ë¡¤ë°” ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ ì²˜ë¦¬ */
      }

      #lyrics-container::-webkit-scrollbar-thumb {
        background-color: var(--primary-color); /* ìŠ¤í¬ë¡¤ë°”ì˜ ë§‰ëŒ€ ë¶€ë¶„ */
        border-radius: 10px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
        border: 2px solid var(--bg-color); /* ë§‰ëŒ€ì™€ ì½˜í…ì¸  ì‚¬ì´ì— ì—¬ë°± íš¨ê³¼ */
      }
    </style>
  </head>
  <body>
    <div id="logo">Better MusicGPT</div>
    <div id="persona-selector-container">
      <div id="current-persona-wrapper">
        <img id="current-persona" src="" alt="Current Persona" />
        <span id="current-persona-name"></span>
      </div>
      <div id="persona-list"></div>
    </div>

    <div id="scene1" class="scene">
      <h1 id="greeting"></h1>
      <textarea id="prompt-input" rows="3" placeholder="ì—¬ê¸°ì— ì´ì•¼ê¸°ë‚˜ ê°ì •ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
      <br />
      <button id="generate-btn">ë…¸ë˜ ìƒì„±</button>
    </div>

    <div id="scene2" class="scene">
      <img id="loading-album-cover" src="" alt="Album cover is generating..." style="display: none" />
      <div class="spinner"></div>
      <p id="loading-text"></p>
      <p id="loading-percent">
        <span class="inline-spinner" style="display: none"></span>
        <span id="percent-text"></span>
      </p>
    </div>

    <div id="scene3" class="scene">
      <button id="new-song-btn">ìƒˆë¡œìš´ ë…¸ë˜ ë§Œë“¤ê¸°</button>
      <div class="player-container">
        <img id="album-cover" src="" alt="Album Cover" />
        <div class="lyrics-section">
          <h2 id="song-title"></h2>
          <audio id="audio-player" controls></audio>
          <div id="lyrics-container"></div>
        </div>
      </div>
    </div>

    <script>
      // =================================================
      // í˜ë¥´ì†Œë‚˜ ë°ì´í„° ì •ì˜
      // =================================================
      const personas = [
        {
          name: 'Quintin',
          persona:
            'Quintin, a 40-year-old logistician from Converse, TX, balances curiosity with practicality, appreciating both new ideas and established methods, and maintains a unique blend of organization and flexibility in all aspects of life.',
          arts_persona:
            "They appreciate the gritty realism of Texas artist David Adickes' sculptures and the soulful melodies of Tejano musician Selena, often visiting the San Antonio Museum of Art and listening to her music while cooking.",
        },
        {
          name: 'Mauricio',
          persona:
            'Mauricio, a reserved yet curious 20-year-old nurse with a passion for photography, balances ambition with pragmatism, preferring intimate gatherings over large social events.',
          arts_persona:
            "Mauricio, inspired by the vivid colors of Frida Kahlo's art and the storytelling of Gabriel GarcÃ­a MÃ¡rquez, finds solace in capturing the essence of moments through his photography and exploring local art galleries on weekends.",
        },
        {
          name: 'Bonnie',
          persona:
            'Bonnie, a sociable Midwesterner, balances curiosity with practicality, hosting potlucks one moment and creating intricate spreadsheets the next, always with a competitive spark in her eye.',
          arts_persona:
            'Bonnie, appreciating both new ideas and established methods, enjoys local folk music performances and occasionally visits art galleries, finding inspiration in the works of Grandma Moses.',
        },
      ];

      // =================================================
      // 1. ëª¨ë“  ê³µìœ  ë°ì´í„°ë¥¼ ë‹´ì„ 'ìƒíƒœ ê°ì²´' ì„ ì–¸
      // =================================================
      const AppStateTemplate = {
        greetingIntervalId: null,
        currentPersona: personas[0],
        genPromptResult: { answer: '', prompt: '', genre: '' },
        genSongResult: { taskId: '', eta: 0 },
        songData: { songTitle: '', songUrl: '', albumCoverUrl: '', lyrics: [] },
      };
      let AppState = JSON.parse(JSON.stringify(AppStateTemplate));

      // Scene 1ì˜ ëœë¤ ë¬¸êµ¬
      const greetings = [
        'ì˜¤ëŠ˜ í•˜ë£¨ ì–´ë– ì…¨ë‚˜ìš”?',
        'ì–´ë–¤ ê°ì •ì„ ë…¸ë˜í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?',
        'ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”.',
        'ì„¸ìƒì— ë‹¨ í•˜ë‚˜ë¿ì¸ ë…¸ë˜ë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”.',
        'ì–´ë–¤ ë©œë¡œë””ë¥¼ ìƒìƒí•˜ê³  ê³„ì‹ ê°€ìš”?',
        'ì§€ê¸ˆì˜ ê¸°ë¶„ì„ ìŒì•…ìœ¼ë¡œ ë‚¨ê²¨ë³´ì„¸ìš”.',
        'ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”?',
        'ë§ˆìŒì„ ìš¸ë¦¬ëŠ” ê°€ì‚¬ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.',
        'ë‹¹ì‹ ì˜ ê°ì„±ì´ ê³§ ë©œë¡œë””ê°€ ë©ë‹ˆë‹¤.',
      ];

      const defaultLoadingText = 'ì œê°€ ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“£ê³  ìˆì–´ìš”...';

      async function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      // í™˜ì˜ ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜
      function startGreetingAnimation() {
        // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ì• ë‹ˆë©”ì´ì…˜ì´ ìˆë‹¤ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        if (AppState.greetingIntervalId) return;

        const $greeting = $('#greeting');

        // 1ì´ˆë§ˆë‹¤ í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜
        const changeGreeting = () => {
          $greeting.fadeTo(400, 0, function () {
            // 0.4ì´ˆ ë™ì•ˆ ì‚¬ë¼ì§€ê¸°
            const currentText = $(this).text();
            let newText;
            // í˜„ì¬ì™€ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ê°€ ì„ íƒë  ë•Œê¹Œì§€ ë°˜ë³µ
            do {
              newText = greetings[Math.floor(Math.random() * greetings.length)];
            } while (newText === currentText);

            $(this).text(newText).fadeTo(400, 1); // í…ìŠ¤íŠ¸ ë³€ê²½ í›„ 0.4ì´ˆ ë™ì•ˆ ë‚˜íƒ€ë‚˜ê¸°
          });
        };

        // 1.5ì´ˆ(1500ms)ë§ˆë‹¤ changeGreeting í•¨ìˆ˜ ì‹¤í–‰
        AppState.greetingIntervalId = setInterval(changeGreeting, 3000);
      }

      // í™˜ì˜ ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ì„ ì¤‘ì§€í•˜ëŠ” í•¨ìˆ˜
      function stopGreetingAnimation() {
        if (AppState.greetingIntervalId) {
          clearInterval(AppState.greetingIntervalId);
          AppState.greetingIntervalId = null;
        }
      }

      function getGravatarUrl(name, size = 80) {
        // GravatarëŠ” ì´ë©”ì¼ í•´ì‹œë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì•„ë¬´ ë¬¸ìì—´ì´ë‚˜ ë„£ì–´ë„ ê¸°ë³¸ ì•„ì´ì½˜(identicon)ì„ ìƒì„±í•´ì¤ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” í˜ë¥´ì†Œë‚˜ ì´ë¦„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const processed = name.trim().toLowerCase();
        const hash = md5(processed);
        return `https://www.gravatar.com/avatar/${hash}?d=identicon&s=${size}`;
      }

      function getPercentage() {
        const percent =
          ((new Date().getTime() - AppState.genSongResult.startTime) / (AppState.genSongResult.eta * 1000)) * 100;
        return Math.round(percent);
      }

      // Sceneì„ ì „í™˜í•˜ëŠ” í•¨ìˆ˜
      function showScene(sceneId) {
        const $nextScene = $('#' + sceneId);

        // í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” Sceneì„ ì°¾ìŠµë‹ˆë‹¤.
        // opacityê°€ 0ë³´ë‹¤ í° ìš”ì†Œë¥¼ ì°¾ê±°ë‚˜, ê°„ë‹¨í•˜ê²ŒëŠ” :visible ì„ íƒìë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        const $currentScene = $('.scene').filter(':visible');

        // í˜„ì¬ ë³´ì´ëŠ” Sceneì´ ìˆë‹¤ë©´
        if ($currentScene.length > 0) {
          // í˜„ì¬ Sceneê³¼ ë‹¤ìŒì— ë³´ì—¬ì¤„ Sceneì´ ë‹¤ë¥¼ ê²½ìš°ì—ë§Œ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
          if ($currentScene.attr('id') !== sceneId) {
            $currentScene.css('pointer-events', 'none'); // ì‚¬ë¼ì§€ëŠ” ë™ì•ˆ í´ë¦­ ë°©ì§€
            $currentScene.fadeTo(500, 0, function () {
              // 0.5ì´ˆ ë™ì•ˆ íˆ¬ëª…í•˜ê²Œ
              $(this).hide(); // ì• ë‹ˆë©”ì´ì…˜ í›„ ì™„ì „íˆ ìˆ¨ê¹€
              // Scene 1ì´ ë‚˜íƒ€ë‚  ë•Œ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
              if (sceneId === 'scene1') {
                startGreetingAnimation();
              }
              $nextScene.show().fadeTo(500, 1, function () {
                // 0.5ì´ˆ ë™ì•ˆ ë‚˜íƒ€ë‚˜ê¸°
                $(this).css('pointer-events', 'auto'); // ë‚˜íƒ€ë‚œ í›„ ë‹¤ì‹œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ
              });
            });
          }
        } else {
          // í˜„ì¬ ë³´ì´ëŠ” Sceneì´ ì—†ë‹¤ë©´ (í˜ì´ì§€ ìµœì´ˆ ë¡œë“œ ì‹œ)
          // Scene 1ì´ ë‚˜íƒ€ë‚  ë•Œ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
          if (sceneId === 'scene1') {
            startGreetingAnimation();
          }
          $nextScene.show().fadeTo(500, 1, function () {
            $(this).css('pointer-events', 'auto');
          });
        }
      }

      // ìƒíƒœ ê°ì²´ë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ëŠ” í•¨ìˆ˜
      function resetStateAndGoToScene1() {
        stopGreetingAnimation(); // âœ’ï¸ ì¶”ê°€: ë¦¬ì…‹ ì‹œ ì• ë‹ˆë©”ì´ì…˜ í™•ì‹¤í•˜ê²Œ ì¤‘ì§€

        // ì˜¤ë””ì˜¤ ì •ì§€ ë° ë¦¬ì…‹
        const audio = $('#audio-player')[0];
        audio.pause();
        audio.src = '';

        const currentPersona = AppState.currentPersona;
        AppState = JSON.parse(JSON.stringify(AppStateTemplate));
        // personaëŠ” ìœ ì§€
        AppState.currentPersona = currentPersona;

        // DOM ì´ˆê¸°í™” ë° Scene 1ìœ¼ë¡œ ì „í™˜
        $('#prompt-input').val('');
        const randomIndex = Math.floor(Math.random() * greetings.length);
        $('#greeting').text(greetings[randomIndex]);
        showScene('scene1');

        // Scene 2 ì´ˆê¸°í™”
        $('#loading-album-cover').hide().attr('src', ''); // ì•¨ë²” ì»¤ë²„ ìˆ¨ê¸°ê³  ì†ŒìŠ¤ ë¹„ìš°ê¸°
        $('.spinner').show(); // ìŠ¤í”¼ë„ˆ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°

        $('#loading-text').text(defaultLoadingText);
        $('#percent-text').text('');
        $('.inline-spinner').hide();
        $('#lyrics-container').scrollTop(0);

        // ğŸ‘‡ ëª¨ë“  sceneì„ ì¦‰ì‹œ ìˆ¨ê¸°ê³ , showSceneì„ í†µí•´ scene1ë§Œ fade-in ì‹œí‚µë‹ˆë‹¤.
        $('.scene').stop(true, true).hide();
        showScene('scene1');
      }

      // =================================================
      // 2. ê° í•¨ìˆ˜ë“¤ì´ 'ìƒíƒœ ê°ì²´'ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
      // =================================================

      // Scene 1: í”„ë¡¬í”„íŠ¸ ì…ë ¥ì°½ ì´ë²¤íŠ¸ ì²˜ë¦¬
      $('#generate-btn').on('click', async function () {
        stopGreetingAnimation(); // âœ’ï¸ ì¶”ê°€: Scene 2ë¡œ ë„˜ì–´ê°€ê¸° ì „ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€

        const userPrompt = $('#prompt-input').val();
        if (!userPrompt) {
          alert('ë…¸ë˜ë¡œ ë§Œë“¤ê³  ì‹¶ì€ ì´ì•¼ê¸°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        // ë¨¼ì € ë¡œë”© í™”ë©´ìœ¼ë¡œ ì „í™˜ ì¤€ë¹„
        $('#loading-text').text(defaultLoadingText); // ê¸°ë³¸ ë¡œë”© í…ìŠ¤íŠ¸
        showScene('scene2');
        // ğŸš¨ ë°±ì—”ë“œ API í˜¸ì¶œ: ë…¸ë˜ ìƒì„± ì‹œì‘
        let response = await fetch('/api/generate-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: userPrompt,
            persona: AppState.currentPersona.persona,
            arts_persona: AppState.currentPersona.arts_persona,
          }),
        });
        const genPromptResult = await response.json();
        console.log(genPromptResult);
        if (!response.ok) {
          throw new Error(genPromptResult?.message); // TODO
        }

        // ğŸ‘‡ 1. ì‘ë‹µ ë°›ì€ answerë¥¼ ë¡œë”© í…ìŠ¤íŠ¸ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
        $('#loading-text').text(genPromptResult.answer);

        AppState.genPromptResult.answer = genPromptResult.answer;
        AppState.genPromptResult.prompt = genPromptResult.prompt;
        AppState.genPromptResult.genre = genPromptResult.genre;

        response = await fetch('/api/generate-song', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: AppState.genPromptResult.prompt, genre: AppState.genPromptResult.genre }),
        });
        const genSongResult = await response.json();
        console.log(genSongResult);
        if (!response.ok) {
          throw new Error(genSongResult?.message); // TODO
        }
        AppState.genSongResult.taskId = genSongResult.task_id;
        AppState.genSongResult.eta = genSongResult.eta;
        AppState.genSongResult.startTime = new Date().getTime();
        AppState.genSongResult.endTime = new Date().getTime() + genSongResult.eta * 1000;

        await startPolling(AppState.genSongResult.taskId);
      });

      // Scene 2: ìƒíƒœ API í´ë§ ì‹œì‘
      async function startPolling(taskId) {
        $('.inline-spinner').show();

        $('#percent-text').text(`${getPercentage()}%`);
        const percentIntervalId = setInterval(function () {
          const percent = getPercentage();
          if (percent <= 100) {
            $('#percent-text').text(`${getPercentage()}%`);
          } else {
            $('#percent-text').text(`ì¡°ê¸ˆë§Œ ë” ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.. ğŸ¥`);
          }
        }, 500);

        while (true) {
          const response = await fetch(`/api/get-song-status?task_id=${taskId}`);
          const statusResult = await response.json();
          console.log(statusResult);
          if (!response.ok) {
            clearInterval(percentIntervalId); // ì—ëŸ¬ ë°œìƒ ì‹œ í¼ì„¼íŠ¸ ì¸í„°ë²Œë„ ì¤‘ì§€
            throw new Error(statusResult?.message); // TODO
          }

          const albumCoverPath = statusResult?.conversion?.album_cover_path;
          // ì•¨ë²” ì»¤ë²„ ê²½ë¡œê°€ ìˆê³ , ì•„ì§ í™”ë©´ì— í‘œì‹œë˜ì§€ ì•Šì•˜ë‹¤ë©´
          if (albumCoverPath && $('#loading-album-cover').is(':hidden')) {
            $('.spinner').hide(); // ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
            $('#loading-album-cover')
              .attr('src', albumCoverPath) // ì´ë¯¸ì§€ ì†ŒìŠ¤ ì„¤ì •
              .fadeIn(); // ë¶€ë“œëŸ½ê²Œ ë‚˜íƒ€ë‚˜ê¸°
          }

          if (
            (statusResult?.conversion?.status === 'COMPLETED' ||
              statusResult?.conversion?.status === 'GENERATION_COMPLETED') &&
            typeof statusResult?.conversion?.title_1 === 'string' &&
            statusResult.conversion.title_1.length > 0 &&
            typeof statusResult?.conversion?.conversion_path_1 === 'string' &&
            statusResult.conversion.conversion_path_1.length > 0 &&
            typeof statusResult?.conversion?.album_cover_path === 'string' &&
            statusResult.conversion.album_cover_path.length > 0 &&
            typeof statusResult?.conversion?.lyrics_timestamped_1 === 'string' &&
            statusResult.conversion.lyrics_timestamped_1.length > 0
          ) {
            clearInterval(percentIntervalId);
            $('.inline-spinner').hide();
            AppState.songData.songTitle = statusResult.conversion.title_1;
            AppState.songData.songUrl = statusResult.conversion.conversion_path_1;
            AppState.songData.albumCoverUrl = statusResult.conversion.album_cover_path;
            AppState.songData.lyrics = JSON.parse(statusResult.conversion.lyrics_timestamped_1);
            displaySong();
            showScene('scene3');
            break;
          }
          await sleep(5000);
        }
      }

      // Scene 3: ë…¸ë˜ ì •ë³´ í‘œì‹œ ë° í”Œë ˆì´ì–´ ì„¤ì •
      function displaySong() {
        $('#song-title').text(AppState.songData.songTitle);
        $('#album-cover').attr('src', AppState.songData.albumCoverUrl);
        $('#audio-player').attr('src', AppState.songData.songUrl);

        const $lyricsContainer = $('#lyrics-container');
        $lyricsContainer.empty();

        AppState.songData.lyrics.forEach((line) => {
          const $p = $('<p>').text(line.text).attr('data-time', line.start);
          $lyricsContainer.append($p);
        });
      }

      // Scene 3: ë…¸ë˜ë°© ê°€ì‚¬ í•˜ì´ë¼ì´íŠ¸ ê¸°ëŠ¥ (ìˆ˜ì •í•  í•„ìš” ì—†ìŒ)
      $('#audio-player').on('timeupdate', function () {
        const currentTime = this.currentTime;
        const $lyrics = $('#lyrics-container p');
        let currentLine = null;

        $lyrics.each(function () {
          const lineTime = parseFloat($(this).data('time')) / 1000;
          if (currentTime >= lineTime) {
            currentLine = $(this);
          }
        });

        if (currentLine && !currentLine.hasClass('highlight')) {
          $lyrics.removeClass('highlight');
          currentLine.addClass('highlight');
          $('#lyrics-container').scrollTop(
            currentLine.offset().top - $('#lyrics-container').offset().top + $('#lyrics-container').scrollTop() - 50,
          );
        }
      });

      // Scene 3: 'ìƒˆë¡œìš´ ë…¸ë˜ ë§Œë“¤ê¸°' ë²„íŠ¼
      $('#new-song-btn').on('click', function () {
        resetStateAndGoToScene1(); // ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
      });

      // ë¬¸ì„œê°€ ì¤€ë¹„ë˜ë©´ ì²« Scene ì‹œì‘
      $(document).ready(function () {
        // --- í˜ë¥´ì†Œë‚˜ ì„ íƒê¸° ì´ˆê¸°í™” ---
        function initializePersonaSelector() {
          const $personaList = $('#persona-list');
          $personaList.empty(); // ëª©ë¡ ë¹„ìš°ê¸°

          // ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ í˜ë¥´ì†Œë‚˜ ëª©ë¡ ì•„ì´í…œ ìƒì„±
          for (const persona of personas) {
            const itemHtml = `
                <div class="persona-item" data-name="${persona.name}">
                    <img src="${getGravatarUrl(persona.name)}" alt="${persona.name}">
                    <span>${persona.name}</span>
                </div>
            `;
            $personaList.append(itemHtml);
          }

          // ê¸°ë³¸ í˜ë¥´ì†Œë‚˜ ì•„ì´ì½˜ ì„¤ì •
          $('#current-persona').attr('src', getGravatarUrl(AppState.currentPersona.name));
          $('#current-persona-name').text(AppState.currentPersona.name);
        }

        initializePersonaSelector();
        resetStateAndGoToScene1(); // ì´ˆê¸° ì§„ì… ì‹œì—ë„ ì´ˆê¸°í™” í•¨ìˆ˜ ì‚¬ìš©

        // --- í˜ë¥´ì†Œë‚˜ ì„ íƒê¸° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

        // í˜„ì¬ í˜ë¥´ì†Œë‚˜ ì•„ì´ì½˜ í´ë¦­ ì‹œ ëª©ë¡ í¼ì¹˜ê¸°/ì ‘ê¸°
        $('#current-persona').on('click', function (e) {
          e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
          $('#persona-list').toggleClass('active');
        });

        // ëª©ë¡ì—ì„œ íŠ¹ì • í˜ë¥´ì†Œë‚˜ ì•„ì´í…œ í´ë¦­ ì‹œ
        $('#persona-list').on('click', '.persona-item', function () {
          const selectedName = $(this).data('name');
          const selectedPersona = personas.find((p) => p.name === selectedName);

          if (selectedPersona) {
            // 1. ì „ì—­ ìƒíƒœ(AppState) ì—…ë°ì´íŠ¸
            AppState.currentPersona = selectedPersona;

            // 2. í˜„ì¬ í˜ë¥´ì†Œë‚˜ ì•„ì´ì½˜ ì´ë¯¸ì§€ ë³€ê²½
            $('#current-persona').attr('src', getGravatarUrl(selectedPersona.name));
            $('#current-persona-name').text(selectedPersona.name);

            // 3. ëª©ë¡ ìˆ¨ê¸°ê¸°
            $('#persona-list').removeClass('active');
          }
        });

        // í™”ë©´ì˜ ë‹¤ë¥¸ ê³³ì„ í´ë¦­í•˜ë©´ ëª©ë¡ ìˆ¨ê¸°ê¸°
        $(document).on('click', function (e) {
          if (!$(e.target).closest('#persona-selector-container').length) {
            $('#persona-list').removeClass('active');
          }
        });

        // --- ë¡œê³  í´ë¦­ ì‹œ ì²« í™”ë©´ìœ¼ë¡œ ---
        $('#logo').on('click', function () {
          // í˜„ì¬ 1ë²ˆ ì”¬ì´ ì•„ë‹ ê²½ìš°ì—ë§Œ ë¦¬ì…‹ í•¨ìˆ˜ í˜¸ì¶œ
          if (!$('#scene1').is(':visible')) {
            resetStateAndGoToScene1();
          }
        });
      });
    </script>
  </body>
</html>
